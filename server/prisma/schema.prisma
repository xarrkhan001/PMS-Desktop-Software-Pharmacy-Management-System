generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Pharmacy {
  id               Int        @id @default(autoincrement())
  name             String
  location         String?
  licenseNo        String?    @unique
  contact          String?
  licenseStartedAt DateTime?  @default(now())
  licenseExpiresAt DateTime?  // When the license will expire
  isActive         Boolean    @default(true) // For manual blocking if needed
  subscriptionFee  Float      @default(0)   // Amount paid for the initial/latest license
  totalPaid        Float      @default(0)   // Cumulative revenue from this pharmacy
  createdAt        DateTime   @default(now())
  
  // Relationships
  users     User[]
  medicines Medicine[]
  sales     Sale[]
  suppliers Supplier[]
  customers Customer[]
  purchases Purchase[]
}

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  name       String?
  password   String
  role       String   @default("STAFF") // SUPER_ADMIN, ADMIN, PHARMACIST, STAFF
  createdAt  DateTime @default(now())
  
  // Link to Pharmacy
  pharmacyId Int?     // Nullable for SUPER_ADMIN
  pharmacy   Pharmacy? @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  
  tokenVersion Int @default(0) // Used to invalidate sessions on password change
}

model Supplier {
  id          Int      @id @default(autoincrement())
  name        String
  contact     String?
  email       String?
  address     String?
  createdAt   DateTime @default(now())
  
  pharmacyId  Int
  pharmacy    Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  purchases   Purchase[]
}

model Customer {
  id          Int      @id @default(autoincrement())
  name        String
  phone       String?
  address     String?
  totalDue    Float    @default(0)
  createdAt   DateTime @default(now())
  
  pharmacyId  Int
  pharmacy    Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  sales       Sale[]
}

model Medicine {
  id          Int      @id @default(autoincrement())
  name        String
  category    String
  genericName String?
  manufacturer String?
  price       Float
  salePrice   Float    // Retail price
  stock       Int      @default(0)
  reorderLevel Int     @default(10) // Alert when stock goes below this
  unitPerPack Int      @default(1)  // e.g., 20 tablets in 1 pack
  unitType    String   @default("Tablet") // Tablet, Capsule, Syrup, etc.
  rackNo      String?  // Shelf/rack location
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Link to Pharmacy
  pharmacyId  Int
  pharmacy    Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  
  // Relationships
  batches     StockBatch[]
  saleItems   SaleItem[]
  purchaseItems PurchaseItem[]
}

model StockBatch {
  id          Int      @id @default(autoincrement())
  batchNo     String
  quantity    Int
  purchasePrice Float
  expiryDate  DateTime
  receivedDate DateTime @default(now())
  
  medicineId  Int
  medicine    Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
}

model Purchase {
  id          Int      @id @default(autoincrement())
  invoiceNo   String?
  totalAmount Float
  paidAmount  Float    @default(0)
  status      String   @default("PENDING") // PENDING, COMPLETED
  createdAt   DateTime @default(now())
  
  supplierId  Int
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  
  pharmacyId  Int
  pharmacy    Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  
  items       PurchaseItem[]
}

model PurchaseItem {
  id          Int      @id @default(autoincrement())
  quantity    Int
  price       Float
  batchNo     String?
  expiryDate  DateTime?
  
  purchaseId  Int
  purchase    Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  
  medicineId  Int
  medicine    Medicine @relation(fields: [medicineId], references: [id])
}

model Sale {
  id          Int      @id @default(autoincrement())
  invoiceNo   String?
  totalAmount Float
  discount    Float    @default(0)
  netAmount   Float
  paidAmount  Float
  dueAmount   Float    @default(0)
  paymentMethod String @default("CASH") // CASH, CARD, ONLINE
  manualCustomerName String?
  manualCustomerAddress String?
  createdAt   DateTime @default(now())
  
  customerId  Int?
  customer    Customer? @relation(fields: [customerId], references: [id])
  
  pharmacyId  Int
  pharmacy    Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  
  items       SaleItem[]
}

model SaleItem {
  id          Int      @id @default(autoincrement())
  quantity    Int
  price       Float
  total       Float
  
  saleId      Int
  sale        Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  
  medicineId  Int
  medicine    Medicine @relation(fields: [medicineId], references: [id])
}
