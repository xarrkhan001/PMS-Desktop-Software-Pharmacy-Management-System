generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Pharmacy {
  id               Int       @id @default(autoincrement())
  name             String
  location         String?
  licenseNo        String?   @unique // Software License Key
  pharmacyLicense  String? // Business/Drug License Number
  ntn              String? // National Tax Number / Tax ID
  contact          String?
  licenseStartedAt DateTime? @default(now())
  licenseExpiresAt DateTime? // When the software license will expire
  isActive         Boolean   @default(true) // For manual blocking if needed
  subscriptionFee  Float     @default(0) // Amount paid for the initial/latest license
  totalPaid        Float     @default(0) // Cumulative revenue from this pharmacy
  createdAt        DateTime  @default(now())

  // Relationships
  users             User[]
  medicines         Medicine[]
  sales             Sale[]
  suppliers         Supplier[]
  customers         Customer[]
  purchases         Purchase[]
  expenses          Expense[]
  expenseCategories ExpenseCategory[]
  paymentHistories  PaymentHistory[]
  auditLogs         AuditLog[]
  settings          PharmacySettings?
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  password  String
  role      String   @default("STAFF") // SUPER_ADMIN, ADMIN, PHARMACIST, STAFF
  createdAt DateTime @default(now())

  // Link to Pharmacy
  pharmacyId Int? // Nullable for SUPER_ADMIN
  pharmacy   Pharmacy? @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  tokenVersion Int        @default(0) // Used to invalidate sessions on password change
  auditLogs    AuditLog[]
}

model Supplier {
  id            Int      @id @default(autoincrement())
  name          String
  contactPerson String?
  contact       String?
  email         String?
  address       String?
  createdAt     DateTime @default(now())

  pharmacyId Int
  pharmacy   Pharmacy   @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  purchases  Purchase[]
}

model Customer {
  id            Int      @id @default(autoincrement())
  name          String
  phone         String?
  address       String?
  totalDue      Float    @default(0)
  loyaltyPoints Int      @default(0)
  totalSpent    Float    @default(0)
  visits        Int      @default(0)
  createdAt     DateTime @default(now())

  pharmacyId Int
  pharmacy   Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  sales      Sale[]
}

model Medicine {
  id           Int     @id @default(autoincrement())
  name         String
  category     String
  genericName  String?
  manufacturer String?
  price        Float
  salePrice    Float // Retail price
  taxRate      Float   @default(0) // Tax percentage (e.g., 0 for medicines, 18 for supplements)
  stock        Int     @default(0)
  reorderLevel Int     @default(10) // Alert when stock goes below this
  unitPerPack  Int     @default(1) // e.g., 20 tablets in 1 pack
  unitType     String  @default("Tablet") // Tablet, Capsule, Syrup, etc.
  rackNo       String? // Shelf/rack location

  // Tracking fields for pre-filling Edit Modals
  initialBatchNo    String?
  initialQuantity   String?
  initialExpiryDate String?

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Link to Pharmacy
  pharmacyId Int
  pharmacy   Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  // Relationships
  batches       StockBatch[]
  saleItems     SaleItem[]
  purchaseItems PurchaseItem[]
}

model StockBatch {
  id            Int      @id @default(autoincrement())
  batchNo       String
  quantity      Int
  purchasePrice Float
  expiryDate    DateTime
  receivedDate  DateTime @default(now())

  medicineId Int
  medicine   Medicine @relation(fields: [medicineId], references: [id], onDelete: Cascade)
}

model Purchase {
  id          Int      @id @default(autoincrement())
  invoiceNo   String?
  totalAmount Float
  paidAmount  Float    @default(0)
  status      String   @default("PENDING") // PENDING, COMPLETED
  createdAt   DateTime @default(now())

  supplierId Int
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  pharmacyId Int
  pharmacy   Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  items PurchaseItem[]
}

model PurchaseItem {
  id         Int       @id @default(autoincrement())
  quantity   Int
  price      Float
  batchNo    String?
  expiryDate DateTime?

  purchaseId Int
  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  medicineId Int
  medicine   Medicine @relation(fields: [medicineId], references: [id])
}

model Sale {
  id                    Int      @id @default(autoincrement())
  invoiceNo             String?
  totalAmount           Float
  discount              Float    @default(0)
  taxAmount             Float    @default(0) // Total tax for the sale
  netAmount             Float
  paidAmount            Float
  dueAmount             Float    @default(0)
  paymentMethod         String   @default("CASH") // CASH, CARD, ONLINE
  manualCustomerName    String?
  manualCustomerAddress String?
  createdAt             DateTime @default(now())

  customerId Int?
  customer   Customer? @relation(fields: [customerId], references: [id])

  pharmacyId Int
  pharmacy   Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  items SaleItem[]
}

model SaleItem {
  id        Int   @id @default(autoincrement())
  quantity  Int
  price     Float
  taxRate   Float @default(0) // Tax rate at time of sale
  taxAmount Float @default(0) // Tax amount for this item
  total     Float

  saleId Int
  sale   Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  medicineId Int
  medicine   Medicine @relation(fields: [medicineId], references: [id])
}

// --- Finance & Accounts Models ---

model ExpenseCategory {
  id          Int       @id @default(autoincrement())
  name        String // e.g., Rent, Utilities, Salaries
  description String?
  pharmacyId  Int
  pharmacy    Pharmacy  @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
  expenses    Expense[]
}

model Expense {
  id            Int      @id @default(autoincrement())
  title         String
  amount        Float
  date          DateTime @default(now())
  description   String?
  paymentMethod String   @default("CASH") // CASH, BANK

  categoryId Int
  category   ExpenseCategory @relation(fields: [categoryId], references: [id])

  pharmacyId Int
  pharmacy   Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
}

// For detailed ledger tracking of partial payments
model PaymentHistory {
  id            Int      @id @default(autoincrement())
  amount        Float
  paymentDate   DateTime @default(now())
  paymentMethod String   @default("CASH") // CASH, CARD, BANK
  note          String?

  // Can be for a sale (customer udhaar) or purchase (supplier udhaar)
  saleId     Int?
  purchaseId Int?

  pharmacyId Int
  pharmacy   Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)
}

// --- Audit & System Logging ---

model AuditLog {
  id     Int    @id @default(autoincrement())
  type   String // sale, purchase, inventory, customer, finance, system
  action String // e.g., "Medicine Added", "Sale Completed"
  detail String // Description of the action
  amount Float? // Optional financial impact
  status String @default("info") // success, warning, error, info

  // Traceability
  userId     Int?
  user       User?    @relation(fields: [userId], references: [id])
  pharmacyId Int
  pharmacy   Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model PharmacySettings {
  id         Int      @id @default(autoincrement())
  pharmacyId Int      @unique
  pharmacy   Pharmacy @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  // Bill Customization
  billHeader       String? @default("Thank you for choosing us!")
  billFooter       String? @default("Medicines once sold will not be returned or exchanged.")
  showPharmacyLogo Boolean @default(true)
  showTaxId        Boolean @default(true)
  showLicense      Boolean @default(true)

  // Financials
  defaultTaxRate Float  @default(0.0) // Percentage
  currencySymbol String @default("PKR")

  // Alerts
  nearExpiryDays    Int @default(30)
  lowStockThreshold Int @default(10)

  updatedAt DateTime @updatedAt
}

model MasterMedicine {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  genericName  String?
  manufacturer String?
  category     String?
  unitType     String?  @default("Tablet")
  createdAt    DateTime @default(now())
}
